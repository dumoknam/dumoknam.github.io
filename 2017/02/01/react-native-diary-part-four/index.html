<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title>React Native 일기장 앱 개발 (3) - realm DB 연동 클래스 · Anything</title><meta name="description" content="React Native 일기장 앱 개발 (3) - realm DB 연동 클래스 - Dumok Nam"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/favicon.ico"><link rel="stylesheet" href="/css/gandalfr.css"><link rel="stylesheet" href="https://highlightjs.org/static/demo/styles/solarized-light.css"><link rel="search" type="application/opensearchdescription+xml" href="http://yoursite.com/atom.xml" title="Anything"></head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="https://avatars2.githubusercontent.com/u/2771223?v=3&amp;s=460" alt="logo"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="https://github.com/dumoknam" target="_blank" class="nav-list-link">GITHUB</a></li><li class="nav-list-item"><a href="/atom.xml" target="_self" class="nav-list-link">RSS</a></li></ul></header><main class="container"><div class="post"><article class="post-block"><h1 class="post-title">React Native 일기장 앱 개발 (3) - realm DB 연동 클래스</h1><div class="tags"><a href="/tags/React-Native/" class="tag-title">#React Native</a><a href="/tags/App/" class="tag-title">#App</a></div><div class="post-info">Feb 1, 2017</div><div class="post-content"><p>모바일 데이터베이스인 <a href="https://realm.io" target="_blank" rel="external">realm</a>을 연동할 클래스를 만들자</p>
<a id="more"></a>
<p><strong>이미지를 클라우드를 쓰다가 직접 올리는 방법으로 바꿨는데 블로그 옮기다가 날려먹었다.. 일기장 포스팅 스크린샷은 없다</strong></p>
<p><em>아이맥 하드가 급 사망하여 윈도우 PC로 대체하였다.. 이번포스팅 부터는 android 기반으로 진행한다.</em></p>
<h1 id="Realm"><a href="#Realm" class="headerlink" title="Realm"></a>Realm</h1><p>일기를 저장하기 위해서는 DB 연동이 필요하다<br><code>sqlite</code>, <code>firebase</code> 등등 다른 DB도 많지만 모바일 환경에 최적화 되었다고 하는 <code>realm(렘)</code>을 사용해보자.</p>
<h2 id="Realm-설치"><a href="#Realm-설치" class="headerlink" title="Realm 설치"></a>Realm 설치</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">npm install --save realm</div><div class="line">react-native link realm <span class="comment"># React Native &gt;= 0.31.0</span></div></pre></td></tr></table></figure>
<p>설치는 다른 node 모듈처럼 <code>npm</code>(혹은 <code>yarn</code>) 명령어로 설치하고,<br>link 명령어가 react-native 프로젝트와 <code>realm</code>을 연결하는 작업을 해준다.<br>(native 코드에 필요한 import, new 등의 작업으로, android는 <code>android\app\src\main\java\com\diary</code> 안의 java 파일에 realm 관련 import 구문이 추가된 것을 볼 수 있다)</p>
<h3 id="error-fix-windows"><a href="#error-fix-windows" class="headerlink" title="error fix (windows)"></a>error fix (windows)</h3><p>realm 사용시 두가지 주의할 점이 있다.<br><em>포스팅은 0.14버전 기준으로, 이후 버전은 다를 수 있다</em></p>
<ol>
<li>cmd, powershell, babun 등 쉘은 반드시 <strong>관리자</strong> 권한으로 실행해야 한다.</li>
<li><code>node_modules\realm\android\build.gradle</code>의 task send()안의 71 번째 줄 version 뒤에 코드를 지우고 version = ‘1’ 로 변경한다.</li>
</ol>
<p>2번은 npm을 path까지 적는 다른 해결법도 있다고 한다. 해보진 않았다.</p>
<h2 id="DiaryRealm"><a href="#DiaryRealm" class="headerlink" title="DiaryRealm"></a>DiaryRealm</h2><p>realm DB에 데이터를 생성, 수정, 삭제, 조회하는 모든 기능은 <code>DiaryRealm.js</code> 한 파일에 구현할 것이다.<br>src 디렉토리 밑에 db 디렉토리를 생성하고, DiaryRealm.js 파일을 생성하자.</p>
<p><code>src\db\DiaryRealm.js</code></p>
<h3 id="Model-Schema"><a href="#Model-Schema" class="headerlink" title="Model Schema"></a>Model Schema</h3><p>첫번째로 일기 DB를 표현할 모델을 만들자.<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">const</span> DiarySchema = &#123;</div><div class="line">  <span class="attr">name</span>: <span class="string">'Diary'</span>,</div><div class="line">  <span class="attr">primaryKey</span>: <span class="string">'id'</span>,</div><div class="line">  <span class="attr">properties</span>: &#123;</div><div class="line">    <span class="attr">id</span>: <span class="string">'int'</span>,</div><div class="line">    <span class="attr">year</span>: &#123; <span class="attr">type</span>: <span class="string">'int'</span>, <span class="attr">indexed</span>: <span class="literal">true</span> &#125;,</div><div class="line">    <span class="attr">month</span>: &#123; <span class="attr">type</span>: <span class="string">'int'</span>, <span class="attr">indexed</span>: <span class="literal">true</span> &#125;,</div><div class="line">    <span class="attr">day</span>: <span class="string">'int'</span>,</div><div class="line">    <span class="attr">content</span>: <span class="string">'string'</span></div><div class="line">  &#125;</div><div class="line">&#125;;</div></pre></td></tr></table></figure></p>
<p>모델을 정의하는 schema에 대한 내용은 <a href="https://realm.io/docs/javascript/latest/#models" target="_blank" rel="external">문서</a>를 참고하자.<br>name에 테이블명을 정의하고 primaryKey에 pk를 적고, DB의 컬럼에 해당하는 property를 정의한다.</p>
<p>일기는 id와 숫자 타입의 연, 월, 일, 그리고 string 타입의 일기 내용 문자열을 property로 갖게 하였다.<br>연,월,일을 date 타입으로 하지 않은건, realm 이 아직 date 타입엔 index를 지원하지 않고,<br>검색 조건에 date를 between 형식으로 비교하는 것도 안되는 것 같아서 연-월-일로 나눠 두었다.</p>
<h3 id="새로-생성할-일기의-ID값-구하기"><a href="#새로-생성할-일기의-ID값-구하기" class="headerlink" title="새로 생성할 일기의 ID값 구하기"></a>새로 생성할 일기의 ID값 구하기</h3><p>PK인 id 값은 고유해야 하므로, 일기를 쓸때마다 매번 달라져야 한다.<br>DB의 시퀀스 처럼 자동으로 증가하는 기능은 없는 것 같아서 id를 구하는 함수를 구현했다.<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">getNextId()&#123;</div><div class="line">  <span class="keyword">var</span> realm = <span class="keyword">this</span>.realm;</div><div class="line">  <span class="keyword">return</span> realm.objects(<span class="string">'Diary'</span>).length+<span class="number">1</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>모든 Diary 데이터 개수에 1을 더하는 형태이다.</p>
<h3 id="Create-일기-데이터-생성"><a href="#Create-일기-데이터-생성" class="headerlink" title="Create, 일기 데이터 생성"></a>Create, 일기 데이터 생성</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">create(data)&#123;</div><div class="line">  <span class="keyword">var</span> realm = <span class="keyword">this</span>.realm;</div><div class="line">  realm.write(<span class="function"><span class="params">()</span>=&gt;</span> &#123;</div><div class="line">    realm.create(<span class="string">'Diary'</span>, data);</div><div class="line">  &#125;);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>데이터 생성은 realm의 create 함수를 호출한다. </p>
<p>data 파라미터는 위에서 정의한 모델 schema와 동일한, 아래와 같은 형태가 될 것이다.<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> diary_data = &#123;</div><div class="line">  <span class="attr">id</span>: <span class="number">1</span>,</div><div class="line">  <span class="attr">year</span>: <span class="number">2017</span>,</div><div class="line">  <span class="attr">month</span>: <span class="number">0</span>,</div><div class="line">  <span class="attr">day</span>: <span class="number">15</span>,</div><div class="line">  <span class="attr">content</span>: <span class="string">'첫번째 데이터'</span></div><div class="line">&#125;;</div></pre></td></tr></table></figure></p>
<h3 id="Update-일기-데이터-수정"><a href="#Update-일기-데이터-수정" class="headerlink" title="Update, 일기 데이터 수정"></a>Update, 일기 데이터 수정</h3><p>수정은 생성과 동일한 <code>create</code> 함수를 사용한다.<br>대신 optional 인자인 세번째 인자 값에 <code>true</code> 를 호출하면 update로 동작한다.<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">update(data)&#123;</div><div class="line">  <span class="keyword">var</span> realm = <span class="keyword">this</span>.realm;</div><div class="line">  realm.write(<span class="function"><span class="params">()</span>=&gt;</span> &#123;</div><div class="line">    realm.create(<span class="string">'Diary'</span>, data, <span class="literal">true</span>);</div><div class="line">  &#125;);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h3 id="Filtering-Sorting-일기-데이터-조회"><a href="#Filtering-Sorting-일기-데이터-조회" class="headerlink" title="Filtering, Sorting, 일기 데이터 조회"></a>Filtering, Sorting, 일기 데이터 조회</h3><p>일기 목록은 한번에 한 달의 목록만 조회할 것이다.<br>조회할 연, 월을 인자로 전달받게 하였다.<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">getDiaryByYearMonth(year, month)&#123;</div><div class="line">  <span class="keyword">var</span> realm = <span class="keyword">this</span>.realm;</div><div class="line">  <span class="keyword">return</span> realm.objects(<span class="string">'Diary'</span>).filtered(<span class="string">'year == $0 and month == $1'</span>, year, month).sorted(<span class="string">'day'</span>, <span class="literal">true</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>조건을 지정하여 조회하는 메소드가 <code>filtered</code> 이고, 데이터를 정렬하는 메소드가 <code>sorted</code> 이다.<br>전체 Diary 중에 인자로 전달받은 year와 month를 각각 $0, $1에 지정하여 조회하도록 하였다.</p>
<p>날짜별로 정렬할 것이므로 <code>sorted</code>에 정렬 기준인 <code>day</code>를, <strong>역순</strong>으로 정렬하기 위해 <code>true</code>를 전달한다.<br><code>sorted(&#39;day&#39;)</code> 처럼 정렬 기준만 쓰거나, <code>sorted(&#39;day&#39;, false)</code> 처럼 두번째 인자로 <code>false</code>를 쓰면 날짜 순서대로 정렬이 된다.</p>
<h3 id="Delete-일기-데이터-삭제"><a href="#Delete-일기-데이터-삭제" class="headerlink" title="Delete, 일기 데이터 삭제"></a>Delete, 일기 데이터 삭제</h3><p>삭제할 <code>id</code>값을 전달받고, <code>delete</code>메소드를 호출하여 해당id값을 갖는 데이터를 삭제한다.<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">delete</span>(diaryId)&#123;</div><div class="line">  <span class="keyword">var</span> realm = <span class="keyword">this</span>.realm;</div><div class="line">  res = realm.delete(realm.objects(<span class="string">'Diary'</span>).filtered(<span class="string">'id == $0'</span>, diaryId));</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h2 id="DiaryRealm-1"><a href="#DiaryRealm-1" class="headerlink" title="DiaryRealm"></a>DiaryRealm</h2><p>DB의 기본 기능인 CRUD에 대한 구현이 다 되었다.<br>전체 파일 내용은 이렇다.<br>{% gist d435b7633e3f4268ee1eb179abc1ac7d DiaryRealm.js %}</p>
<p>잘 연동되나 확인해보자.<br>두 파일만 수정하면 된다.</p>
<h2 id="DiaryListView-수정"><a href="#DiaryListView-수정" class="headerlink" title="DiaryListView 수정"></a>DiaryListView 수정</h2><p>리스트뷰에서 수정할 부분은 <code>state</code>의 <code>datasource</code>를 지정하는 곳과 <code>renderRow</code> 이다.<br><code>realm</code>에서 제공하는 리스트를 사용하도록 <code>import</code>도 수정하였다.<br>{% gist e22ea01d28fe83bfd453583d3ea1a5b5 DiaryListView.js %}</p>
<p>임시 일기 데이터인 <code>TempDiaryContents</code> 를 불러오던 코드를 삭제하고,<br><code>realm</code>의 <code>getDiaryByYearMonth</code> 메소드 결과값을 datasource로 설정하도록 변경하였다.<br><em>javascript의 월(month)은 0~11이어서 1월을 0으로 사용하였다</em></p>
<p>2017년 1월을 하드코딩 해서 사용중인데.. 날짜를 선택하는 기능도 다음에 추가될 것이다.</p>
<p><code>renderRow</code>에서 바뀐건 타이틀 텍스트 부분이다.<br>위에서 정의한 schema에 <code>title</code> 이라는 property가 없으므로,<br><code>rowData.title</code> 를 <code>rowData.month+1 - rowData.day</code> 로 변경하였다.</p>
<h2 id="WriteButton-수정"><a href="#WriteButton-수정" class="headerlink" title="WriteButton 수정"></a>WriteButton 수정</h2>{% gist 40fc61aaef6fe8930447e12575b41819 WriteButton.js %}
<p>WriteButton 터치시 Alert이 나타나던 부분을 삭제하고, 임의로 3개의 데이터를 생성하도록 변경하였다.<br>id값은 매번 <code>getNextId</code>를 호출하여 새로운 값을 받아오도록 하였다.</p>
<h2 id="확인"><a href="#확인" class="headerlink" title="확인"></a>확인</h2><p><code>react-native run-android</code>로 에뮬레이터에 앱을 실행하고,</p>
<p><strong>이미지 없음</strong> <!--![before](before.png)--></p>
<p>글쓰기 버튼 (+)을 누르면, 아무 변화가 없다..<br><em>데이터 추가시 자동갱신은 구현하지 않았다..</em></p>
<p>키보드의 R 키를 두번 눌러 페이지를 리로드 하면 잘 보인다.<br><strong>이미지 없음</strong> <!--![after](after.png)--></p>
<p>realm 연동이 되었으니, 다음엔 글쓰기 화면을 만들어 보자.</p>
<p>오늘은 이만!</p>
<h4 id="참고-console-log"><a href="#참고-console-log" class="headerlink" title="참고 - console.log"></a>참고 - console.log</h4><p><code>console.log</code> 로 출력하는 값은 바로 볼 수가 없는데,<br><code>react-native log-android</code> 명령을 실행하면 이곳에 나타난다.</p>
<p>중간중간 값을 찍으면서 진행하고자 한다면, <code>log-android</code>나 <code>log-ios</code>를 사용하자.</p>
</div></article></div></main><footer><div class="paginator"><a href="/2017/03/20/react-native-diary-part-five/" class="prev">PREV</a><a href="/2017/01/14/react-native-diary-part-three/" class="next">NEXT</a></div><div id="disqus_thread"></div><script>var disqus_shortname = 'dumok';
var disqus_identifier = '2017/02/01/react-native-diary-part-four/';
var disqus_title = 'React Native 일기장 앱 개발 (3) - realm DB 연동 클래스';
var disqus_url = 'http://yoursite.com/2017/02/01/react-native-diary-part-four/';
(function() {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();</script><script id="dsq-count-scr" src="//dumok.disqus.com/count.js" async></script><div class="copyright"><p>© 2017 <a href="http://yoursite.com">Dumok Nam</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/MikeCoder/hexo-theme-gandalfr" target="_blank">hexo-theme-gandalfr</a>.</p></div></footer></div><script src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML" integrity="sha384-crwIf/BuaWM9rM65iM+dWFldgQ1Un8jWZMuh3puxb8TOY9+linwLoI7ZHZT+aekW" crossorigin="anonymous"></script><script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.9.0/highlight.min.js" crossorigin="anonymous"></script><script src="//cdn.bootcss.com/jquery/3.1.1/jquery.js" crossorigin="anonymous"></script><script>$(document).ready(function() { $('pre').each(function(i, block) { hljs.highlightBlock(block); }); });</script></body></html>